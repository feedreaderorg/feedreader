@page "/login"
@page "/login/{OAuthProvider}"
@inject NavigationManager NavigationManager

@if (CurrentUser.Role != UserRole.Guest)
{
    NavigationManager.NavigateTo("/");
}
else if (string.IsNullOrEmpty(OAuthProvider))
{
    var callbackUri = NavigationManager.ToAbsoluteUri("/login/microsoft");
    var microsoftLoginUri = $"https://login.microsoftonline.com/consumers/oauth2/v2.0/authorize?client_id=dcaaa2ba-a614-4b8c-b78e-1fb39cb8899a&redirect_uri={callbackUri}&response_type=id_token&scope=openid+profile&nonce=feedreader";

    callbackUri = NavigationManager.ToAbsoluteUri("/login/google");
    var googleLoginUri = $"https://accounts.google.com/o/oauth2/v2/auth?client_id=830207024957-oh9b7oth864jtkb32glia884o0neq1vl.apps.googleusercontent.com&redirect_uri={callbackUri}&response_type=id_token&scope=openid&nonce=feedreader";
    
    <div class="login">
        <div class="wrapper">
            <div class="title">Welcome back</div>
            <div class="vstack gap-2">
                <a class="btn btn-primary" href="@microsoftLoginUri">
                    <i class="bi bi-microsoft" /> Continue with Microsoft
                </a>
                <a class="btn btn-primary" href="@googleLoginUri">
                    <i class="bi bi-google" /> Continue with Google
                </a>
            </div>
        </div>
    </div>
}
else
{
    <Waiting Text="logging in"/>
}

@code
{
    [CascadingParameter]
    public User CurrentUser { get; set; }

    [Parameter]
    public string OAuthProvider { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(OAuthProvider))
        {
            try
            {
                await CurrentUser.LoginAsync(ExtractJwtTokenFromCallbackUri(NavigationManager.Uri));
                NavigationManager.NavigateTo("/");
            }
            catch (Exception ex)
            {
                var title = HttpUtility.UrlEncode("Login Failed");
                var detail = HttpUtility.UrlEncode(ex.Message);
                var backTitle = HttpUtility.UrlEncode("Back to Login");
                var backUri = HttpUtility.UrlEncode("/login");
                NavigationManager.NavigateTo($"/error?title={title}&detail={detail}&backTitle={backTitle}&backUri={backUri}");
            }
        }
    }

    private string ExtractJwtTokenFromCallbackUri(string callbackUri)
    {
        // Get jwt token from the uri.
        var fragment = callbackUri.Substring(callbackUri.IndexOf('#') + 1);
        var queries = HttpUtility.ParseQueryString(fragment);
        var token = queries["id_token"];
        if (token == null)
        {
            var error = queries["error"];
            if (error == null)
            {
                throw new Exception($"Unexpected error in callback uri: {callbackUri}.");
            }
            else
            {
                throw new Exception($"Get error from callback uri: {error}");
            }
        }
        else
        {
            return token;
        }
    }
}